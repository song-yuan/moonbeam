<?php/* * ******************************************************************************* * Copyright(C),2015, Glory * FileName: Forward.php * Author:  stephen * Version: v2.0 * Date:  2015/03/17 * Description:  Forward * ******************************************************************************** */class Forward extends WebScrap {    const STATION = 'FWRD';    const HOME_URL = 'http://www.fwrd.com/';        private $currencyUrl='http://www.fwrd.com/r/ajax/SetCurrency.jsp';    //构造函数    function __construct($bFindAlternativeProduct = false) {        parent::__construct($bFindAlternativeProduct);    }    //销毁函数    function __destruct() {        parent::__destruct();    }    public function init() {        $this->area = '美国';                $this->getCookieFile();                $this->citys = array('美国' => 'USD', '香港' => 'HKD', '中国' => 'CNY');                $this->station = self::STATION;    }    private function getAlternativeProduct($city) {        if (is_array($this->alternative)) {            $this->info['alternative'] = implode(';', $this->alternative);        }        if ($this->bFindAlternativeProduct && is_array($this->alternative)) {            foreach ($this->alternative as $pid) {                $productaddr = self::HOME_URL . '/product/' . $pid;                $product = new MrPorter();                $pid = $product->productAnaly($productaddr, $city);                unset($product);            }        }    }    private function checkStock() {        $node = $this->htmlParser->getElementById('add-to-bag-btn');        if($node!==NULL){            $this->isInStock = true;            $this->trace('有存货');        }else{            $this->trace('无存货');        }    }    //解析单个商品    public function productAnaly($url, $city = '') {                if (parent::productAnaly($url, $city) === false) {            $this->trace('不支持该城市采集!');            return false;        }                if(curl_post_cookie($this->currencyUrl, $this->cookie_file, 'currency='.$this->citys[$this->city])=== false){            $this->trace('cookie失败');            return false;        }                if ($this->htmlParser->loadURL($this->url, $this->cookie_file) === false) {            $this->trace('无法取得网站数据');            return false;        }        if($this->getpid()===false){            return false;        }        $this->checkStock();                $this->setProductInfo();        return false;        return $this->saveInfo();    }    //采集单页面    public function collectSinglePage($url, $city = '') {        $ret = false;        try {            $html = $this->getHtmlDom($url, $this->cookie_file);            $links = $this->findProductLinks($html);            $this->trace("查找到商品数: " . strval(count($links)));            $html->clear();            unset($html);        } catch (Exception $e) {                    }        $this->saveProductLinks($links);        unset($links);        return true;    }    public function collectPage($url, $city = '') {        $this->trace('此网点不允许翻页处理.');    }    //得到页数 <span class="page-numbers">第3/10页</span>    public function getPageCount($url) {        $pageCount = 0;        $html = getHtmlDomAtCookie($url, $this->cookie_file);        if ($html == false)            return $pageCount;        $ret = $html->find('span.page-on');        if ($ret == null)            return $pageCount;        foreach ($ret as $key => $info) {            $reg = '/(\d{1,99}(\.\d+)?)/is';            preg_match_all($reg, $info->plaintext, $result);            if (is_array($result) && !empty($result) && !empty($result[1]) && !empty($result[1][1])) {                $pageCount = $result[1][1];                $this->trace('搜索到页数: ' . (string) $pageCount);                return $pageCount;            }            return $pageCount;        }    }    //得到当前页码    private function getcurrentPageNum($url) {        $array_query = parse_url($url);        $page = 1;        try {            if (isset($array_query['query'])) {                $item = explode('=', $array_query['query']);                $page = intval($item[1]);            }        } catch (Exception $e) {                    }        return $page;    }    //得到商品信息    public function getProductInfo($desc) {        if (array_key_exists($desc, $this->info))            return $this->info[$desc];        return false;    }    //搜索商品链接    private function findProductLinks($html) {        $temps = array();        $links = array();        //连接        foreach ($html->find('div[class=tall-product-image] a') as $key => $element) {            if ($key == self::MAX_P)                break;            $productaddr = self::HOME_URL . $element->href;            $temps[] = trim($productaddr);            $this->trace('搜索到商品链接:' . $productaddr);        }        $links = array_unique($temps);        unset($temps);        return $links;    }    //设置商品信息    private function setProductInfo() {        if (!$this->isInStock) return;                $productinfo = $this->htmlParser->getElementByClass('product_info');        if($productinfo===NULL) return;                $brand = $this->htmlParser->getElementByClassFromParent($productinfo,'h1','designer_brand');        if($brand!==false){            $this->brandName = trim($brand->textContent);            $this->trace('品牌:' . $this->brandName);        }                $title = $this->htmlParser->getElementByClassFromParent($productinfo,'h2','product_name');        if($title!==false){            $this->productTitle = trim($title->textContent);            $this->trace('商品名:' . $this->productTitle);        }                $price_box = $this->htmlParser->getElementByClassFromParent($productinfo,'div','price_box');        if($price_box!==false){                        $price = $this->htmlParser->getElementByClassFromParent($productinfo,'span','price');            if($price!==false){                $this->listPrice = analyPrice(trim($price->textContent));                $this->trace('原价:' . $this->listPrice);            }                        $discount = $this->htmlParser->getElementByClassFromParent($productinfo,'span','discount_price');            if($discount!==false){                $this->sellingPrice = analyPrice(trim($discount->textContent));                $this->trace('价格:' . $this->sellingPrice);            }        }                $this->colors = array();        $color_dd = $this->htmlParser->getElementByClassFromParent($productinfo,'div','color_dd');        if($color_dd!==false){                            $color = $this->htmlParser->getElementByClassFromParent($color_dd,'div','one_sizeonly');                if($color!==false){                    $colorobj = new stdClass;                    $colorobj->code = '0';                    $colorobj->image = null;                    $colorobj->name = trim($this->textContent);                    $this->colors[] = $colorobj;                }else{                    $colorselect = $this->htmlParser->getElementByIdFromParent($color_dd,'select','color-select');                    if($colorselect!==false){                    $this->trace('find color-select');                    $this->relevanceProduct = array();                    $colors = $this->htmlParser->getElementsByTagFromParent($colorselect, 'option');                    $this->trace($colors );                    foreach ($colors as $key => $color) {                                                $colValue = trim($color->getAttribute('value'));                        if ($key==0) {                            $colorobj = new stdClass;                            $colorobj->code = '0';                            $colorobj->image = null;                            $colorobj->name = $colValue;                            $this->colors[] = $colorobj;                        }else{                            $this->relevanceProduct[] = trim($color->getAttribute('data-dp-url'));                        }                     }                }                }        }                $this->trace('颜色:' );        $this->trace($this->colors);                return;            $this->getSwatches($html);            $this->getSizes($html);            $this->getImages($html);            $this->getDetailsAndDesigner($html);    }    //商品编号    private function getpid() {        $node = $this->htmlParser->getElementById('prev-next-div');        if($node!==NULL && $node->hasAttribute('data-code')){            $id = $node->getAttribute('data-code');            $this->pid = trim($id);            $this->id = self::STATION . $this->pid;            $this->trace("商品ID:" . $this->pid);            return true;        }        $this->trace("找不到商品ID");        return false;    }    //尺寸描述    private function getSizeFitContainer($url) {        if (!$this->getProductInfo('pid'))            return;        if ($this->getProductInfo('sizes')) {            if ($this->info['sizes'] == 'one-size')                return;        }        $this->getOrgId($this->info['pid']);        $requrl = self::NET_A_PORTER_SIZECHART . $this->info['orgid'];        $reps = $this->curl_cookie_url($requrl);        if ($reps == false) {            return false;        }        $html = str_get_html($reps);        if ($html == false)            return false;        try {            $ret = $html->find('ul.content');            if (empty($ret))                return false;            foreach ($ret as $key => $info) {                $str = trim($info->outertext);                $this->info['sizeFitContainer'] = preg_replace("#<a[^>]*>(.*?)</a>#is", '', $str);                $this->trace('尺寸描述:' . $this->info['sizeFitContainer']);                return;            }        } catch (Exception $e) {                    }        unset($html);    }    //品牌    private function getBrand($html) {        $info = $html->find('#product-details h1', 0);        $this->info['brandName'] = trim($info->plaintext);        $this->trace('品牌:' . $this->info['brandName']);    }    //标题    private function getTitle($html) {        $info = $html->find('#product-details h4', 0);        $this->info['productTitle'] = trim($info->plaintext);        $this->trace('商品名:' . $this->info['productTitle']);    }    //价格    private function getPrice($html) {        $info = $html->find('span[class=price-value]', 0);        $stPrice = trim($info->plaintext);        $this->info['price'] = $this->analyPrice($stPrice);        $this->trace('现价:' . $this->info['price']);    }    //图片    private function getImages($html) {        $this->info['images'] = array();        $this->info['images']['0'] = array();        $find = $html->find('span[class=colour]');        foreach ($html->find('div[id=product-carousel] img') as $el) {            $imgAddr = $el->getAttribute('src');            $imgAddr = 'http:' . str_replace('xs', 'xl', $imgAddr);            if ($this->downImage($imgAddr)) {                $this->info['images']['0'][] = $imgAddr;                //               resizeJpg("product/" . $imgName, 336, 350);            }        }        $this->trace('图片:');        $this->trace($this->info['images']);    }    //颜色样本    private function getSwatches($html) {        $this->alternative = array();        $this->info['colors'] = array();        $info = $html->find('span[class=colour]', 0);        if (empty($info)) {            foreach ($html->find('#select-colour option') as $key => $el) {                if ($key == 0) {                    $this->colorname = trim($el->plaintext);                    $colorobj = new stdclass;                    $colorobj->code = '0';                    $colorobj->image = null;                    $colorobj->name = $this->colorname;                    $this->info['colors'][] = $colorobj;                } else {                    $this->alternative[] = $el->getAttribute('value');                }            }        } else {            $this->colorname = trim($info->plaintext);            $colorobj = new stdclass;            $colorobj->code = '0';            $colorobj->image = null;            $colorobj->name = $this->colorname;            $this->info['colors'][] = $colorobj;        }    }    private function filterBracket($stText) {        $pos = strpos($stText, '(');        if ($pos != false)            $stText = substr($stText, 0, $pos);        $pos = strpos($stText, '-');        if ($pos != false)            $stText = substr($stText, 0, $pos);        return trim($stText);    }    private function filterStock($stClass) {        if (strcmp("greyed", $stClass) === 0)            return 0;        $stock = str_replace("max", '', $stClass);        return intval($stock);    }    //尺寸    private function getSizes($html) {        $this->info['stock'] = 0;        $this->info['sku'] = array();        $this->info['sizes'] = array();        foreach ($html->find('select[id=select-size] option') as $element) {            if (!isset($element->class{0}))                continue;            $sku = new stdClass;            $sku->color = $this->colorname;            $sku->size = $this->filterBracket($element->plaintext);            $sku->count = $this->filterStock($element->class);            $sizeobj = new stdClass;            $sizeobj->name = $sku->size;            $sizeobj->code = $sku->size;            $sizeobj->image = null;            $this->info['sizes'][] = $sizeobj;            $this->info['stock'] += $sku->count;            $this->info['sku'][] = $sku;        }        $this->trace('货存查询：' . $this->info['stock']);    }    //说明    private function getDetailsAndDesigner($html) {        $ret = $html->find('div[class=productContentPiece]');        if (empty($ret))            return;        foreach ($ret as $key => $info) {            if ($key == 0) {                $this->info['details'] = trim($info->innertext);                $this->trace('商品信息:' . $this->info['details']);            } else if ($key == 1) {                $this->info['sizeFitContainer'] = trim($info->innertext);                $this->trace('尺寸描述:' . $this->info['sizeFitContainer']);            } else if ($key == 2) {                $this->info['desc'] = trim($info->innertext);                $this->trace('产品信息:' . $this->info['desc']);                return;            }        }    }}?>